<html lang="en">
<head>
    <meta charset="utf-8">
    <title>DEMO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    {% load staticfiles %}

    <!-- Le styles -->
    <link href="{% static "font-awesome/css/font-awesome.min.css" %}" rel="stylesheet">
    <link href="{% static "css/dropzone.css" %}" rel="stylesheet">
    <link href="{% static "css/dropzone-style.css" %}" rel="stylesheet">
    <link href="{% static "bootstrap/css/bootstrap-theme.css" %}" rel="stylesheet">
    <link href="{% static "bootstrap/css/bootstrap.css" %}" rel="stylesheet">
    <style>
        body { padding-top: 70px; }
    </style>

  </head>

  <body>

    <!-- HEADER -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">
                    Uploader
                </a>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="form-group">
            <label id="output_name_title">Output Name</label>
            <input type="text" class="form-control" id="output_name">
        </div>
    </div>

    <!-- Upload Section -->
    <div class="container">
        <div id="dropzone">
            <form id="my-dropzone" action="{% url "upload_file" %}" method="post" class="dropzone dz-clickable" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="dz-message">
                    Drop files here or click to upload.<br>
                </div>
            </form>
        </div>
    </div>
    <div class="container">
        <button id="submit-all" class="btn btn-primary">
            <i class="glyphicon glyphicon-upload"></i>
            <span>Process</span>
        </button>
        <button id="clear-dropzone" class="btn btn-warning">
            <i class="glyphicon glyphicon-trash"></i>
            <span>Clear</span>
        </button>
    </div>

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script src="{% static "js/jquery-1.11.2.min.js" %}" type="text/javascript"></script>
    <script src="{% static "bootstrap/js/bootstrap.min.js" %}" type="text/javascript"></script>
    <script src="{% static "bootstrap/js/npm.js" %}" type="text/javascript"></script>
    <script src="{% static "js/dropzone.js" %}"></script>

        <script language="javascript">
        Dropzone.options.myDropzone = {
            autoProcessQueue : false,
            parallelUploads: 10,


            init: function() {
                var submitButton = document.querySelector("#submit-all");
                var myDropzone = this;

                submitButton.addEventListener("click", function() {
                    myDropzone.processQueue();
                    // Tell Dropzone to process all queued files.
                });

                var removeButton = document.querySelector("button#clear-dropzone");
                removeButton.addEventListener("click", function() {
                    myDropzone.removeAllFiles();
                });
                
                // Hide the total progress bar when nothing's uploading anymore
                myDropzone.on("queuecomplete", function(progress) {
                    //document.querySelector("#total-progress").style.opacity = "0";
                    //alert("queue complete!");
                    var outputName = $('#output_name').val();
                    //alert(typeof outputName);
                    if (outputName != undefined && outputName != '') {
                        //alert("outputName if fine.");
                        jQuery.getJSON('/uploader/process', {output_name: outputName}, function (data) {
                            if (data == 'Success') {
                                window.location.href = "https://cps-xena.cps.cmich.edu/mergecolumns/#" + outputName;
                            } else {
                                alert("Something went wrong!");
                            }
                        });
                    } else {
                        alert("You must enter an output file name!");
                    }
                });
            }
        };
        </script>

  </body>
</html>
